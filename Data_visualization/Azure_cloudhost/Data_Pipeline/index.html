<!-- 
  Marble Accelerator - Real-time Visualization
  ============================================

  Description:
    This HTML file serves as the frontend for the Marble Accelerator project.
    It connects to a FastAPI WebSocket server running at "/ws" and displays real-time charts of data received from the hardware.

  Features:
    - Uses Plotly.js to render four live-updating charts.
    - Displays:
        D1: sensor data 1
        D2: sensor data 2
       
    - Automatically connects using "ws://" or "wss://" depending on protocol.
    - Updates charts continuously as new JSON messages arrive.

  Usage:
    1. Run the serial_reader_pc.py code to read stm32 data and to ingest it into azure web app
    2. Scan the QR code or go to the AZURE URL : https://pipeline-server-buecbybefda4azh6.francecentral-01.azurewebsites.net/ to access the dashboard
    3. Observe real-time sensor data visualization on PC as well as on mobile device browsers.

  =======================================================================
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Marble Accelerator </title>

  <!-- Plotly.js for chart rendering -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <!-- html2canvas for capturing dashboard as an image -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
  body {
    font-family: Arial, Helvetica, sans-serif;
    margin: 0;
    padding: 20px;
    position: relative;   /* needed so ::before can attach */
    z-index: 0;
  }

  body::before {
    content: "";
    position: fixed;      /* cover whole screen */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;

    background-image: url("/static/Marble_img.png");
    background-repeat: no-repeat;
    background-size: cover;       
    background-position: center;  
    background-attachment: fixed;

    opacity: 0.7;         /*makes image faded*/
    z-index: -1;           /* ensures it stays behind content */
  }

    h2 {
      text-align: center;
      font-size: 27px;
      font-weight: 600;
      color: rgba(37, 18, 18, 0.874);
      border-radius: 8px;
      border: 4px solid #fbfafa;
      background: #efd4a0;
      max-width: 640px;
      margin: 0 auto 30px;
      padding: 25px 20px 17px;
      box-shadow: #3a2d2d 10px 10px 7px, 
                    inset 10px 10px 14px #3a2d2d;
    }

    /* Grid layout for charts (2 columns) */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding-left: 40px;
    }

    /* Container around each chart */
    .chart-container {
      background: white;
      border-radius: 12px;
      margin: 20px;
      padding: 15px;
      box-shadow: 12px 12px 14px rgba(50, 38, 24, 0.747),
                  inset 4px 4px 6px #644c34;
    }
    .chart-container > div {
      height: 350px; /* fix chart height */
    
    }

    /* Download button styling (top-right corner) */
    #downloadDashboardBtn {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 12px;
      font-weight: 500;
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid #aaa;
      box-shadow: rgb(77, 42, 42) 2px 3px 6px,
                  inset 1px 1px 4px #623c3c;
      background: #f4dab2;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    #downloadDashboardBtn svg {
      width: 18px;
      height: 18px;
      fill: #333;
      transition: fill 0.2s;
    }

    /* Hover effect for button */
    #downloadDashboardBtn:hover {
      background: #007bff;   /* blue background */
      color: white;          /* white text */
    }
    #downloadDashboardBtn:hover svg {
      fill: white;           /* white icon on hover */
    }
  </style>
</head>
<body>
  <h2>Marble Accelerator Dashboard</h2>

  <!-- Button placed top-right -->
  <button id="downloadDashboardBtn">
    <!-- Download icon (SVG) -->
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 16l4-5h-3V4h-2v7H8l4 5zm-7 2v2h14v-2H5z"/>
    </svg>
    Download
  </button>

  <div class="grid">
    <div class="chart-container"><div id="chart1"></div></div>
    <div class="chart-container"><div id="chart2"></div></div>
   
  </div>

  <script>
    // Decide protocol
    let protocol = location.protocol === "https:" ? "wss://" : "ws://";
    let ws = new WebSocket(protocol + location.host + "/ws");

    // Fixed X-axis: 100 samples [0..99]
    const x_vals = Array.from({ length: 100 }, (_, i) => i);

    // Normalize array length to 100 samples
    const normalize = (arr) => {
      if (!Array.isArray(arr)) return Array(100).fill(null);
      if (arr.length > 100) return arr.slice(0, 100);
      if (arr.length < 100) return arr.concat(Array(100 - arr.length).fill(null));
      return arr;
    };

    // Handle incoming WebSocket messages
    ws.onmessage = (event) => {
      let data = JSON.parse(event.data); // Parse received JSON

      let d1 = normalize(data.D1 || []);
      let d2 = normalize(data.D2 || []);

      // Layout template
      const layout_template = (title, x_label, y_label) => ({
        title: { text: title, font: { size: 16, weight: "bold" } },
        margin: { l: 70, r: 20, t: 40, b: 50 },
        xaxis: {
          title: x_label,
          showline: true,
          linecolor: 'black',
          linewidth: 2,
          ticks: 'outside',
          range: [0, 99],
          showgrid: true
        
  
    },
        yaxis: {
          title: { text: y_label, standoff: 5 },
          automargin: true,
          showline: true,
          linecolor: 'black',
          linewidth: 2,
          ticks: 'outside',
          showgrid: true
        }
      });

      // Plotly config
      const config = {
        displaylogo: false,
        modeBarButtonsToRemove: [
          'zoom2d', 'pan2d', 'select2d', 'lasso2d',
          'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d',
          'hoverClosestCartesian', 'hoverCompareCartesian',
          'toggleSpikelines', 'resetViews', 'toggleHover'
        ]
      };

      // Create plots
      Plotly.newPlot("chart1", [{
        x: x_vals, y: d1, type: "scatter", mode: "lines",
        line: { color: "brown", width: 2 }
      }], layout_template("Sensor 1", "Samples", "Magnetic Field (T)"), config);

      Plotly.newPlot("chart2", [{
        x: x_vals, y: d2, type: "scatter", mode: "lines",
        line: { color: "indigo", width: 2 }
      }], layout_template("Sensor 2", "Samples", "Magnetic Field (T)"), config);

    };

    // Capture dashboard as PNG
    document.getElementById("downloadDashboardBtn").addEventListener("click", () => {
      let grid = document.querySelector(".grid");
      html2canvas(grid).then(canvas => {
        let link = document.createElement("a");
        link.download = "dashboard.png";                 
        link.href = canvas.toDataURL("image/png");       
        link.click();                                    
      });
    });
  </script>
</body>
</html>


